---
title: 用命令实现一个vpc网络(bridge+vxlan)                        
author: opengers
layout: post
permalink: /openstack/create-a-vpc-network-with-commands/
categories: openstack
tags:
  - openstack
  - vpc
  - namespace
  - vxlan
---   

* TOC
{:toc}    

><small>openstack中常用的一种vpc实现方式为bridge+vxlan，本文会通过敲命令方式一步一步地模仿实现一个这样的vpc网络(同网段跨节点通信，可以dhcp，绑定浮动IP等)，这样能够更深入理解vpc的实现原理，本文主要基于openstack中的VPC</small>        

VPC(Virtual Private Cloud)，即虚拟私有云，是openstack或各大云平台提供给用户的一个隔离的专属的网络环境，其构建在通用硬件设备之上，具有很大灵活性，允许我们自定义自己的网络拓扑，ip网段，网关，路由规则等。               
        
- 虚拟意思是其用软件实现，所有的VPC共用底层硬件资源池，底层硬件资源由云管理员维护，对用户透明，既然是虚拟的，就是说用户的VPC网络不与底层某几台特定硬件设备绑定，底层硬件设备可能经常新旧更替，但用户无感知                 

- 私有意思是不同的VPC之间逻辑隔离，A用户创建的VPC跟平台上B用户创建的VPC之间逻辑隔离，无法通信，逻辑隔离的主流实现方式是基于隧道技术，每个VPC都有一个独立的隧道id(tunnel id)，一个VPC内的虚拟机之间的通信数据包都会经过隧道封装(带有tunnel id)，然后送到物理网络上进行传输。逻辑隔离而不是物理隔离，也就是说A用户的虚拟机可能与B用户的虚拟机位于底层同一物理机上，但A，B用户因为其VPC的隧道id不同(位于两个平行的路由平面)，所以无法进行通信。这种逻辑隔离的好处就是可以通过软件控制，比硬件隔离灵活很多。当然，上面说的VPC间隔离是指二层隔离，三层隔离需要靠安全组实现。那如果需要不同VPC实现二层互联也是可以的，比如可以通过IPsec-VPN，专线接入等方式                                
- 既然称为虚拟私有云，而不是虚拟路由器或虚拟交换机，也就意味着在VPC内你可以通过软件定义网络的方式创建虚拟路由器，虚拟交换机，定义IP网段，路由表，网关等，当然也可以利用路由器实现不同IP网段互通，随你定义。         

上面简单介绍了下VPC，接下来我们仿照openstack Neutron中bridge+vxlan实现VPC的方式，来用命令实现一个类似的VPC网络             

# 准备硬件环境     

第一步当然是准备我们的硬件环境，这里需要三台测试机器(物理机或虚拟机，如果用虚拟机，需要注意虚拟机嵌套)，三台机器要求如下      

- 第一台机器作为网络节点，用作虚拟机dhcp，NAT网关等          
- 后两台机器作为两台计算节点，用于实现并测试VPC间的逻辑隔离，同一VPC内同一IP网段的虚拟机可能分布在两台计算节点上，我们会看到他们是如何通过隧道封装进行通信                

| hostname | ip | 作用 | 
| --------- | -------- |
| ctl | eth0: 172.16.207.228\neth1 | 
| node-1 | eth0: 172.16.207.229 |   
| node-2 | eth0: 172.16.207.230 | 
{:.mbtablestyle}       
<br />





